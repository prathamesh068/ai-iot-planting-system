<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI + IOT Smart Agriculture System</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      text-align: center;
    }
    th {
      background: #2e7d32;
      color: #fff;
    }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
  </style>
</head>

<body>

<h1>ðŸŒ± AI + IOT Smart Agriculture System</h1>

<div class="grid">
  <div class="card">
    <h3>Temperature (Â°C)</h3>
    <canvas id="tempChart"></canvas>
  </div>

  <div class="card">
    <h3>Humidity (%)</h3>
    <canvas id="humidityChart"></canvas>
  </div>

  <div class="card">
    <h3>Light Condition</h3>
    <canvas id="lightChart"></canvas>
  </div>

  <div class="card">
    <h3>Soil Condition</h3>
    <canvas id="soilChart"></canvas>
  </div>
</div>

<div class="card" style="margin-top: 30px;">
  <h3>Latest Readings</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Temp</th>
        <th>Humidity</th>
        <th>Light</th>
        <th>Soil</th>
        <th>Image</th>
        <th>Disease</th>
        <th>Confidence</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SHEET_ID = "1ns-4EP_eRR5WDlHlKTnPc-MXrRrKl_TP4LNPajDsb-0";
const SHEET_NAME = "plant_readings";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}`;

fetch(URL)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;

    const labels = [];
    const temps = [];
    const hums = [];
    const lightCount = { DARK: 0, BRIGHT: 0 };
    const soilCount = { DRY: 0, WET: 0 };

    const tableBody = document.querySelector("#dataTable tbody");

    rows.slice(-20).forEach(r => {
      const time = r.c[0]?.v || "";
      const temp = r.c[1]?.v;
      const hum = r.c[2]?.v;
      const light = r.c[3]?.v;
      const soil = r.c[4]?.v;
      const img = r.c[5]?.v;
      const disease = r.c[6]?.v;
      const conf = r.c[7]?.v;
      const action = r.c[8]?.v;

      labels.push(time);
      temps.push(temp);
      hums.push(hum);

      if (light) lightCount[light]++;
      if (soil) soilCount[soil]++;

      tableBody.innerHTML += `
        <tr>
          <td>${time}</td>
          <td>${temp}</td>
          <td>${hum}</td>
          <td>${light}</td>
          <td>${soil}</td>
          <td><a href="${img}" target="_blank">View</a></td>
          <td>${disease}</td>
          <td>${conf}</td>
          <td>${action}</td>
        </tr>`;
    });

    createLineChart("tempChart", labels, temps, "Temperature");
    createLineChart("humidityChart", labels, hums, "Humidity");
    createPieChart("lightChart", Object.keys(lightCount), Object.values(lightCount));
    createPieChart("soilChart", Object.keys(soilCount), Object.values(soilCount));
  });

function createLineChart(id, labels, data, label) {
  new Chart(document.getElementById(id), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label,
        data,
        borderWidth: 2,
        fill: false
      }]
    }
  });
}

function createPieChart(id, labels, data) {
  new Chart(document.getElementById(id), {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data
      }]
    }
  });
}
</script>

</body>
</html>
